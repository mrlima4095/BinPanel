{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Domínios</h5>
                        <h2 id="domainCount">0</h2>
                    </div>
                    <i class="fas fa-globe fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Usuários</h5>
                        <h2 id="userCount">0</h2>
                    </div>
                    <i class="fas fa-users fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Emails Hoje</h5>
                        <h2 id="emailCount">0</h2>
                    </div>
                    <i class="fas fa-envelope fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Status</h5>
                        <h6 id="systemStatus">Online</h6>
                    </div>
                    <i class="fas fa-check-circle fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Atividade Recente</h5>
            </div>
            <div class="card-body">
                <div id="recentActivity">Carregando...</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Domínios Ativos</h5>
            </div>
            <div class="card-body">
                <div id="activeDomains">Carregando...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Configurar axios para incluir token JWT
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('access_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// Função para fazer refresh do token
async function refreshToken() {
    try {
        const refreshToken = localStorage.getItem('refresh_token');
        const response = await axios.post('/api/refresh', {}, {
            headers: {
                Authorization: `Bearer ${refreshToken}`
            }
        });
        
        localStorage.setItem('access_token', response.data.access_token);
        return true;
    } catch (error) {
        window.location.href = '/login';
        return false;
    }
}

// Interceptor para tratar token expirado
axios.interceptors.response.use(
    response => response,
    async error => {
        if (error.response?.status === 401) {
            const refreshed = await refreshToken();
            if (refreshed) {
                return axios(error.config);
            }
        }
        return Promise.reject(error);
    }
);

// Carregar dados do dashboard
async function loadDashboardData() {
    try {
        const [domainsRes, usersRes] = await Promise.all([
            axios.get('/api/domains'),
            axios.get('/api/users')
        ]);
        
        document.getElementById('domainCount').textContent = domainsRes.data.length;
        document.getElementById('userCount').textContent = usersRes.data.length;
        
        // Atualizar domínios ativos
        const activeDomains = domainsRes.data.slice(0, 5);
        document.getElementById('activeDomains').innerHTML = 
            activeDomains.map(d => 
                `<div class="mb-2">
                    <i class="fas fa-globe text-primary"></i>
                    <strong>${d.domain_name}</strong>
                    <br><small>${d.company_name || 'Sem empresa'}</small>
                </div>`
            ).join('');
            
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
    }
}

// Carregar dados quando a página carregar
document.addEventListener('DOMContentLoaded', loadDashboardData);

// Atualizar a cada 60 segundos
setInterval(loadDashboardData, 60000);
</script>
{% endblock %}